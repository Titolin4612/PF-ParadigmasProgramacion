@{
    ViewData["Title"] = "Registro - Blessings and Curses";
    var prefillNickname = ViewBag.PrefillNickname as string ?? "";
}

<div class="game-container">
    <img src="~/images/title-logo.png" alt="Blessings and Curses" class="title-logo" />

    @* Mensaje si se redirigió desde Login porque el usuario NO EXISTE *@
    @* AHORA USARÁ EL ESTILO .error-banner *@
    @if (ViewBag.Prompt != null)
    {
            <div class="error-banner" id="signup-prompt-server"> @* Cambiado de info-banner a error-banner *@
            @* <i class="fas fa-exclamation-triangle"></i> *@ @* Opcional, si quieres mantener un icono *@
            @ViewBag.Prompt
            </div>
    }

    @* Mensaje de Error general del signup (ej. nickname ya existe, contraseña corta) *@
    @if (ViewBag.Error != null)
    {
            <div class="error-banner" id="signup-error-server">
            @ViewBag.Error
            </div>
    }

    <div class="error-banner" id="signup-error-client" style="display: none;">
        <span id="signup-error-client-message"></span>
    </div>

    <div class="form-container">
        <form method="post" asp-action="Signup" id="signup-form" novalidate>
            @* <h2>Crear Cuenta</h2> *@

            <div style="margin-bottom: 16px;">
                <input name="nickname" id="signup-nickname" type="text" placeholder="Elige tu nickname"
                       class="game-input" value="@prefillNickname"
                       required minlength="4" maxlength="50" pattern="^[A-Za-z0-9]+$"
                       title="El nickname debe tener al menos 4 caracteres y solo puede contener letras y números." />
            </div>

            <div style="margin-bottom: 16px;">
                <input name="contraseña" id="signup-contraseña" type="password" placeholder="Crea una contraseña"
                       class="game-input" required minlength="6" maxlength="100"
                       title="La contraseña debe tener al menos 6 caracteres." />
            </div>

            <div class="button-group">
                <button type="submit" class="play-button">Registrarse</button>
                <a asp-controller="Home" asp-action="Login" class="rules-button">Ya tengo cuenta</a>
            </div>
        </form>
    </div>

    <img src="~/images/character-male.png" alt="Personaje Masculino" class="character male" />
    <img src="~/images/character-female.png" alt="Personaje Femenino" class="character female" />
</div>

@section Scripts {
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                function manageBanner(bannerElement, messageContent, isClientError = false) {
                    // Misma función manageBanner que en Login.cshtml
                    if (bannerElement) {
                        const messageSpan = isClientError ? bannerElement.querySelector('span') : null;
                        const hasContent = isClientError ? (messageContent && messageContent.trim() !== "") : (bannerElement.textContent.trim() !== "");

                        if (hasContent) {
                            if (isClientError && messageSpan) messageSpan.textContent = messageContent;
                            bannerElement.style.display = "block"; 
                            bannerElement.style.opacity = "1";
                            bannerElement.style.animation = "fadeIn 0.5s ease-out";

                            setTimeout(() => {
                                bannerElement.style.opacity = "0";
                                setTimeout(() => {
                                    bannerElement.style.display = "none";
                                    bannerElement.style.animation = "";
                                }, 500); 
                            }, 4000); 
                        } else {
                            bannerElement.style.display = "none";
                            bannerElement.style.opacity = "0";
                        }
                    }
                }

                const promptBanner = document.getElementById("signup-prompt-server");
                if (promptBanner && promptBanner.textContent.trim() !== "") {
                    manageBanner(promptBanner, null);
                }

                const serverErrorBanner = document.getElementById("signup-error-server");
                 if (serverErrorBanner && serverErrorBanner.textContent.trim() !== "") {
                    manageBanner(serverErrorBanner, null);
                }

                const signupForm = document.getElementById("signup-form");
                const nicknameInput = document.getElementById("signup-nickname");
                const passwordInput = document.getElementById("signup-contraseña");
                const clientErrorBanner = document.getElementById("signup-error-client");

                signupForm.addEventListener("submit", function (event) {
                    let errorMessageText = null;

                    clientErrorBanner.style.display = "none";
                    clientErrorBanner.style.opacity = "0";

                    const nickname = nicknameInput.value.trim();
                    if (nickname.length === 0) {
                        errorMessageText = "El campo nickname es obligatorio.";
                    } else if (nickname.length < 4) {
                        errorMessageText = "El nickname debe tener al menos 4 caracteres.";
                    } else if (!/^[A-Za-z0-9]+$/.test(nickname)) {
                        errorMessageText = "El nickname solo puede contener letras y números.";
                    }

                    if (!errorMessageText) {
                        const password = passwordInput.value;
                        if (password.length === 0) {
                            errorMessageText = "El campo contraseña es obligatorio.";
                        } else if (password.length < 6) {
                            errorMessageText = "La contraseña debe tener al menos 6 caracteres.";
                        }
                    }

                    if (errorMessageText) {
                        event.preventDefault();
                        manageBanner(clientErrorBanner, errorMessageText, true);
                    }
                });
            });
        </script>
}